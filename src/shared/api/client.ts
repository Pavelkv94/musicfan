import createClient, { type Middleware } from "openapi-fetch";
import type { paths } from "./schema"; // generated by openapi-typescript

const baseUrl = 'https://musicfun.it-incubator.app/api/1.0';

let refreshPromise: Promise<void> | null = null;

function makeRefreshToken() {
    if (!refreshPromise) {
        refreshPromise = (async (): Promise<void> => {
            const refreshToken = localStorage.getItem('musicfan-refreshToken');
            if (!refreshToken) {
                throw new Error('No refresh token found');
            }

            const response = await fetch(`${baseUrl}/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'api-key': 'b24ee7ff-d9a9-4404-bb94-aead42c29c9e'
                },
                body: JSON.stringify({
                    refreshToken
                })
            });

            if (!response.ok) {
                localStorage.removeItem('musicfan-accessToken');
                localStorage.removeItem('musicfan-refreshToken');
                throw new Error('Failed to refresh token');
            }

            const data = await response.json();
            localStorage.setItem('musicfan-accessToken', data.accessToken);
            localStorage.setItem('musicfan-refreshToken', data.refreshToken);
        })();

        refreshPromise.finally(() => {
            refreshPromise = null;
        });

        return refreshPromise;
    }
}

const myMiddleware: Middleware = {
    async onRequest({ request }) {
        // set "foo" header
        const accessToken = localStorage.getItem('musicfan-accessToken');
        if (accessToken) {
            request.headers.set('Authorization', `Bearer ${accessToken}`);
        }

        //@ts-expect-error save original request to retry it after refresh
        request._retryRequest = request.clone();

        return request;
    },
    async onResponse({ request, response }) {
        if (response.ok) return response;

        if (!response.ok && response.status !== 401) {
            // Will produce error messages like "https://example.org/api/v1/example: 404 Not Found".
            throw new Error(`${response.url}: ${response.status} ${response.statusText}`);
        }
        try {
            await makeRefreshToken();
            //@ts-expect-error get original request to retry it after refresh
            const originalRequest = request._retryRequest;

            const retryRequest = new Request(originalRequest.url, {
                method: originalRequest.method,
                headers: new Headers(originalRequest.headers),
                body: originalRequest.body
            });
            retryRequest.headers.set('Authorization', `Bearer ${localStorage.getItem('musicfan-accessToken')}`);

            return fetch(retryRequest);
        } catch (error) {
            console.error(error);
            return response;
        }

        return response;
    }
};

const client = createClient<paths>({
    baseUrl,
    headers: {
        'api-key': 'b24ee7ff-d9a9-4404-bb94-aead42c29c9e'
    }
});

client.use(myMiddleware);

export default client;